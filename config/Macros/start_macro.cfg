[gcode_macro START_PRINT]
description: >
  Start a print with multiple optional steps (Optimized & Safe)
gcode:
  M117  ;Очистить экран от старых сообщений
  {% set bed_temp = params.BED_TEMP|float %}
  {% set extruder_temp = params.EXTRUDER_TEMP|float %}
  {% set mesh_min = params.MESH_MIN|default('') %}
  {% set mesh_max = params.MESH_MAX|default('') %}

  # --- Получаем состояние всех наших переключателей из сохраненных переменных ---
  {% set mesh_mode = printer.save_variables.variables.mesh_mode|default('adaptive') %}
  {% set purge_enabled = printer.save_variables.variables.line_purge_enabled|default(True) %}
  {% set clear_enabled = printer.save_variables.variables.nozzle_clear_enabled|default(True) %}
  
  # --- Задаем безопасную температуру для всех замеров ---
  {% set probe_temp = 140 %}

  # --- ЭТАП 1: Начальный нагрев и парковка XY ---
  M190 S{bed_temp}  ; Нагреть стол и дождаться
  G28 X Y           ; Припарковать ТОЛЬКО оси X и Y

  # --- ЭТАП 2: Опциональная очистка сопла ---
  {% if clear_enabled %}
    {action_respond_info("Очистка сопла включена. Выполняется NOZZLE_CLEAR.")}
    # NOZZLE_CLEAR сам управляет температурой и в конце должен оставить ее на probe_temp
    NOZZLE_CLEAR HOT_MAX_TEMP={extruder_temp - 20}
  {% else %}
    {action_respond_info("Очистка сопла отключена. Пропускаем.")}
  {% endif %}
  
  # --- ЭТАП 3: Предварительный нагрев для Z-парковки и калибровки ---
  {action_respond_info("Предварительный нагрев сопла до %sC для Z-замеров." % probe_temp)}
  M109 S{probe_temp} ; Установить безопасную температуру и дождаться

  # --- ЭТАП 4: Единственная парковка по Z и калибровка сетки ---
  G28 Z             ; Теперь выполняем единственную и точную парковку по Z
  BED_MESH_CLEAR

  # --- Логика выбора режима сетки ---
  {% if mesh_mode == 'load' %}
    {action_respond_info("Режим: ЗАГРУЗКА. Попытка загрузить профиль 'default'.")}
    {% if 'default' in printer.bed_mesh.profiles %}
      BED_MESH_PROFILE LOAD=default
      {action_respond_info("Профиль 'default' успешно загружен.")}
    {% else %}
      {action_respond_info("ОШИБКА: Профиль 'default' не найден! Выполняется ПОЛНАЯ калибровка.")}
      BED_MESH_CALIBRATE
    {% endif %}
  {% elif mesh_mode == 'adaptive' %}
    {action_respond_info("Режим: АДАПТИВНЫЙ.")}
    {% if mesh_min %}
      {action_respond_info("Данные от слайсера получены. Запуск адаптивной калибровки.")}
      BED_MESH_CALIBRATE MESH_MIN="{mesh_min}" MESH_MAX="{mesh_max}" ADAPTIVE=1
    {% else %}
      {action_respond_info("Данные от слайсера не получены. Запуск ПОЛНОЙ калибровки.")}
      BED_MESH_CALIBRATE
    {% endif %}
  {% else %}
    {action_respond_info("Режим: ПОЛНАЯ КАЛИБРОВКА. Запуск полной калибровки стола.")}
    BED_MESH_CALIBRATE
  {% endif %}

  # --- ЭТАП 5: Финальный нагрев и опциональная очистка ---
  {action_respond_info("Нагрев сопла до рабочей температуры.")}
  M109 S{extruder_temp}

  {% if purge_enabled %}
    {action_respond_info("Очищающая полоса включена. Выполняется _LINE_PURGE.")}
    _LINE_PURGE
  {% else %}
    {action_respond_info("Очищающая полоса отключена. Пропускаем.")}
  {% endif %}

[gcode_macro SET_MESH_MODE_FULL]
description: Режим сетки -> ПОЛНАЯ КАЛИБРОВКА
gcode:
  SAVE_VARIABLE VARIABLE=mesh_mode VALUE='"full"'
  {action_respond_info("Режим сетки установлен: ПОЛНАЯ КАЛИБРОВКА. (Сохранено)")}

[gcode_macro SET_MESH_MODE_ADAPTIVE]
description: Режим сетки -> АДАПТИВНАЯ (по умолчанию)
gcode:
  SAVE_VARIABLE VARIABLE=mesh_mode VALUE='"adaptive"'
  {action_respond_info("Режим сетки установлен: АДАПТИВНАЯ. (Сохранено)")}

[gcode_macro SET_MESH_MODE_LOAD]
description: Режим сетки -> ЗАГРУЗИТЬ ИЗ ПАМЯТИ
gcode:
  SAVE_VARIABLE VARIABLE=mesh_mode VALUE='"load"'
  {action_respond_info("Режим сетки установлен: ЗАГРУЗКА профиля 'default'. (Сохранено)")}

[gcode_macro ENABLE_LINE_PURGE]
description: Включить очищающую полосу (purge)
gcode:
  SAVE_VARIABLE VARIABLE=line_purge_enabled VALUE=True
  {action_respond_info("Очищающая полоса (purge) ВКЛЮЧЕНА. (Сохранено)")}

[gcode_macro DISABLE_LINE_PURGE]
description: Выключить очищающую полосу (purge)
gcode:
  SAVE_VARIABLE VARIABLE=line_purge_enabled VALUE=False
  {action_respond_info("Очищающая полоса (purge) ВЫКЛЮЧЕНА. (Сохранено)")}

[gcode_macro ENABLE_NOZZLE_CLEAR]
description: Включить очистку сопла (NOZZLE_CLEAR)
gcode:
  SAVE_VARIABLE VARIABLE=nozzle_clear_enabled VALUE=True
  {action_respond_info("Очистка сопла (NOZZLE_CLEAR) ВКЛЮЧЕНА. (Сохранено)")}

[gcode_macro DISABLE_NOZZLE_CLEAR]
description: Выключить очистку сопла (NOZZLE_CLEAR)
gcode:
  SAVE_VARIABLE VARIABLE=nozzle_clear_enabled VALUE=False
  {action_respond_info("Очистка сопла (NOZZLE_CLEAR) ВЫКЛЮЧЕНА. (Сохранено)")}