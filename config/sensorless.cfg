[force_move]
enable_force_move: True

[gcode_macro _HOME_X]
gcode:
    # --- БЛОК УПРАВЛЕНИЯ ТОКОМ ---
    {% set HOME_CURRENT = 0.8 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    G4 P200 ; Короткая пауза для применения тока

    # --- ЛОГИКА ПАРКОВКИ X ---
    G28 X

    # --- БЛОК ВОССТАНОВЛЕНИЯ ТОКА ---
    # <--- ИЗМЕНЕНИЕ: Восстанавливаем ток ДО отъезда от края
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    G4 P200 ; Пауза для стабилизации тока

    # --- ОТЪЕЗД ОТ КРАЯ НА ПОЛНОМ ТОКЕ ---
    G91
    G0 X-10 F1200
    G90


[gcode_macro _HOME_Y]
gcode:
    # --- БЛОК УПРАВЛЕНИЯ ТОКОМ ---
    {% set HOME_CURRENT = 0.8 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    G4 P200 ; Короткая пауза для применения тока

    # --- ЛОГИКА ПАРКОВКИ Y ---
    G28 Y

    # --- БЛОК ВОССТАНОВЛЕНИЯ ТОКА ---
    # <--- ИЗМЕНЕНИЕ: Восстанавливаем ток ДО отъезда от края
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    G4 P200 ; Пауза для стабилизации тока

    # --- ОТЪЕЗД ОТ КРАЯ НА ПОЛНОМ ТОКЕ ---
    G91
    G0 Y-10 F1200
    G90

[gcode_macro _HOME_Z]
gcode:
    # --- Подготовка ---
    SET_GCODE_OFFSET Z=0
    G90  # Начинаем в абсолютном режиме

    # --- Безопасное перемещение в центр стола ---
    {% set z_max = printer.configfile.settings.stepper_z.position_max %}
    SET_KINEMATIC_POSITION Z={z_max}
    
    {% set x_center = (printer.configfile.settings.stepper_x.position_min + printer.configfile.settings.stepper_x.position_max) / 2 %}
    {% set y_center = (printer.configfile.settings.stepper_y.position_min + printer.configfile.settings.stepper_y.position_max) / 2 %}
    G1 X{x_center} Y{y_center} F{150 * 60}

    # --- Процедура зондирования ---
    # Первая, быстрая проба
    PROBE SPEED={printer.configfile.settings.stepper_z.homing_speed} SAMPLES=1

    G91  # Включаем ОТНОСИТЕЛЬНЫЙ режим
    G1 Z{printer.configfile.settings.stepper_z.homing_retract_dist} F{printer.configfile.settings.stepper_z.homing_retract_speed * 60}
    G90  # Возвращаем АБСОЛЮТНЫЙ режим для следующей команды PROBE

    # Вторая, медленная и точная проба (используется speed из load_cell_probe или second_homing_speed)
    PROBE SPEED={printer.configfile.settings.stepper_z.second_homing_speed}

    # Устанавливаем правильную нулевую точку
    SET_KINEMATIC_POSITION Z=-{printer.configfile.settings.load_cell_probe.z_offset}

    # --- ИСПРАВЛЕНИЕ 2: Финальный относительный подъем ---
    G91  # Снова включаем ОТНОСИТЕЛЬНЫЙ режим
    G1 Z10 F{printer.configfile.settings.load_cell_probe.lift_speed * 60}
    G90  # Завершаем макрос в стандартном абсолютном режиме

[homing_override]
axes: xyz
gcode:
  {% set home_all = ('X' not in params) and ('Y' not in params) and ('Z' not in params) %}

  # --- Этап 1: Безопасный подъем Z, если он еще не припаркован ---
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z=10
    G90
    G0 Z10 F600
  {% endif %}

  # --- Этап 2: Парковка X и Y ---
  # Паркуем X и Y только если это полная парковка (G28) или если запрошена парковка Z.
  # Это гарантирует, что перед парковкой Z оси XY всегда будут припаркованы.
  {% if home_all or 'Z' in params %}
    # Если оси УЖЕ припаркованы, мы не будем делать это снова.
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
      _HOME_X
      _HOME_Y
    {% endif %}
  {% else %}
    # Этот блок выполняется для отдельных G28 X или G28 Y
    {% if 'X' in params %}
      _HOME_X
    {% endif %}
    {% if 'Y' in params %}
      _HOME_Y
    {% endif %}
  {% endif %}

  # --- Этап 3: Парковка Z ---
  # Паркуем Z только если это полная парковка (G28) или если запрошена парковка Z (G28 Z).
  {% if home_all or 'Z' in params %}
    _HOME_Z
  {% endif %}