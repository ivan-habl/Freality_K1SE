[force_move]
enable_force_move: True

[gcode_macro _HOME_X]
gcode:
    # --- БЛОК УПРАВЛЕНИЯ ТОКОМ ---
    {% set HOME_CURRENT = 0.8 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    G4 P200 ; Короткая пауза для применения тока

    # --- ЛОГИКА ПАРКОВКИ X ---
    G28 X

    # --- БЛОК ВОССТАНОВЛЕНИЯ ТОКА ---
    # <--- ИЗМЕНЕНИЕ: Восстанавливаем ток ДО отъезда от края
    {% set RUN_CURRENT_X = printer.configfile.settings['autotune_tmc stepper_x'].run_current|default(printer.configfile.settings['tmc2209 stepper_x'].run_current)|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['autotune_tmc stepper_y'].run_current|default(printer.configfile.settings['tmc2209 stepper_y'].run_current)|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    G4 P200 ; Пауза для стабилизации тока

    # --- ОТЪЕЗД ОТ КРАЯ НА ПОЛНОМ ТОКЕ ---
    G91
    G0 X-10 F1200
    G90


[gcode_macro _HOME_Y]
gcode:
    # --- БЛОК УПРАВЛЕНИЯ ТОКОМ ---
    {% set HOME_CURRENT = 0.8 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    G4 P200 ; Короткая пауза для применения тока

    # --- ЛОГИКА ПАРКОВКИ Y ---
    G28 Y

    # --- БЛОК ВОССТАНОВЛЕНИЯ ТОКА ---
    # <--- ИЗМЕНЕНИЕ: Восстанавливаем ток ДО отъезда от края
    {% set RUN_CURRENT_X = printer.configfile.settings['autotune_tmc stepper_x'].run_current|default(printer.configfile.settings['tmc2209 stepper_x'].run_current)|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['autotune_tmc stepper_y'].run_current|default(printer.configfile.settings['tmc2209 stepper_y'].run_current)|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    G4 P200 ; Пауза для стабилизации тока

    # --- ОТЪЕЗД ОТ КРАЯ НА ПОЛНОМ ТОКЕ ---
    G91
    G0 Y-10 F1200
    G90

[gcode_macro _HOME_Z_FROM_LAST_PROBE]
gcode:
    {% set z_probed = printer.probe.last_z_result %}
    {% set z_position = printer.toolhead.position[2] %}
    {% set z_actual = z_position - z_probed %}
    SET_KINEMATIC_POSITION Z={z_actual}

[gcode_macro _HOME_Z]
gcode:
    # --- Сброс предыдущих смещений ---
    SET_GCODE_OFFSET Z=0

    # --- Абсолютный режим ---
    G90

    # --- Безопасное "мягкое" хомингование Z: установка максимальной позиции ---
    {% set z_max = printer.toolhead.axis_maximum[2] %}
    SET_KINEMATIC_POSITION Z={z_max}

    # --- Перемещение в центр стола ---
    {% set x_center = (printer.toolhead.axis_minimum[0] + printer.toolhead.axis_maximum[0]) / 2 %}
    {% set y_center = (printer.toolhead.axis_minimum[1] + printer.toolhead.axis_maximum[1]) / 2 %}
    G1 X{x_center} Y{y_center} F{150 * 60}

    # --- Быстрая проба (первое приближение) ---
    PROBE PROBE_SPEED={printer.configfile.settings.stepper_z.homing_speed} SAMPLES=1
    _HOME_Z_FROM_LAST_PROBE

    # --- Отъезд на retract_dist ---
    G91
    G1 Z{printer.configfile.settings.stepper_z.homing_retract_dist} F{printer.configfile.settings.stepper_z.homing_retract_speed * 60}
    G90

    # --- Точная проба ---
    PROBE
    _HOME_Z_FROM_LAST_PROBE

    # --- Подъём после завершения homing ---
    G91
    G1 Z10 F{printer.configfile.settings.load_cell_probe.lift_speed * 60}
    G90

[homing_override]
axes: xyz
gcode:
  {% set home_all = ('X' not in params) and ('Y' not in params) and ('Z' not in params) %}

  # --- Этап 1: Безопасный подъем Z, если он еще не припаркован ---
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z=10
    G90
    G0 Z10 F600
  {% endif %}

  # --- Этап 2: Парковка X и Y ---
  # Паркуем X и Y только если это полная парковка (G28) или если запрошена парковка Z.
  # Это гарантирует, что перед парковкой Z оси XY всегда будут припаркованы.
  {% if home_all or 'Z' in params %}
    # Если оси УЖЕ припаркованы, мы не будем делать это снова.
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
      _HOME_X
      _HOME_Y
    {% endif %}
  {% else %}
    # Этот блок выполняется для отдельных G28 X или G28 Y
    {% if 'X' in params %}
      _HOME_X
    {% endif %}
    {% if 'Y' in params %}
      _HOME_Y
    {% endif %}
  {% endif %}

  # --- Этап 3: Парковка Z ---
  # Паркуем Z только если это полная парковка (G28) или если запрошена парковка Z (G28 Z).
  {% if home_all or 'Z' in params %}
    _HOME_Z
  {% endif %}
